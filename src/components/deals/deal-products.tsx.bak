'use client'

import { useState, useEffect } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../ui/card'
import { Badge } from '../ui/badge'
import { Button } from '../ui/button'
import { Separator } from '../ui/separator'
import { Input } from '../ui/input'
import { Label } from '../ui/label'
import { Textarea } from '../ui/textarea'
import { useLabels } from '../../hooks/useLabels'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '../ui/dialog'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '../ui/select'
import {
  Plus,
  Package,
  DollarSign,
  Calendar,
  CircleDollarSign,
  ExternalLink,
  Loader2,
  Edit,
  ChevronDown,
  ChevronRight,
  Receipt,
  Users,
  X,
  Check,
  Trash2,
  CreditCard,
} from 'lucide-react'
import { Deal, Product, Schedule } from '../../types'
import { useUpdateProduct, useCreateProduct, useDeleteProduct } from '../../hooks/useProducts'
import { useUpdateSchedule, useCreateSchedule, useBatchUpdateScheduleSplits, useDeleteSchedule } from '../../hooks/useSchedules'
import { useAgentSearch } from '../../hooks/useAgents'
import { useFilter } from '../../contexts/filter-context'
import { useQueryClient } from '@tanstack/react-query'
import { dealKeys } from '../../hooks/useDeals'
import { scheduleKeys } from '../../hooks/useSchedules'
import { ProductsViewSelector, ProductViewType } from './products-view-selector'
import { GroupedTableView } from './product-table-views/grouped-table-view'
import { FlatTableView } from './product-table-views/flat-table-view'
import { MasterDetailView } from './product-table-views/master-detail-view'
import { CompactRowsView } from './product-table-views/compact-rows-view'

interface DealProductsProps {
  deal: Deal
  highlightedScheduleId?: string
  highlightedProductId?: string
  onNavigateToPayment?: (paymentId: string) => void
}

export function DealProducts({ deal, highlightedScheduleId, highlightedProductId, onNavigateToPayment }: DealProductsProps) {
  const { labels } = useLabels()

  // Initialize view from localStorage
  const [view, setView] = useState<ProductViewType>(() => {
    if (typeof window !== 'undefined') {
      const savedView = localStorage.getItem('deal-products-view-preference')
      return (savedView as ProductViewType) || 'modular'
    }
    return 'modular'
  })

  // Save view preference to localStorage whenever it changes
  useEffect(() => {
    localStorage.setItem('deal-products-view-preference', view)
  }, [view])

  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false)
  const [isAddScheduleDialogOpen, setIsAddScheduleDialogOpen] = useState(false)
  const [editingProduct, setEditingProduct] = useState<Product | null>(null)
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false)
  const [selectedProductForView, setSelectedProductForView] = useState<Product | null>(null)
  const [selectedProductForSchedule, setSelectedProductForSchedule] = useState<string>('')
  const [expandedProducts, setExpandedProducts] = useState<Set<string>>(new Set())
  const [selectedSchedule, setSelectedSchedule] = useState<any>(null)
  const [editingSchedule, setEditingSchedule] = useState<Schedule | null>(null)
  const [isEditScheduleDialogOpen, setIsEditScheduleDialogOpen] = useState(false)
  const [isLinkProjectDialogOpen, setIsLinkProjectDialogOpen] = useState(false)
  const [linkProjectId, setLinkProjectId] = useState('')
  const [linkingProduct, setLinkingProduct] = useState<Product | null>(null)
  const [scheduleAgentSplits, setScheduleAgentSplits] = useState<Map<string, Array<{
    id?: string
    agentName: string
    agentId?: string | null
    splitPercent: number
    splitAmount: number
  }>>>(new Map())
  const [editingSplitId, setEditingSplitId] = useState<string | null>(null)
  const [agentSearchTerm, setAgentSearchTerm] = useState('')
  const [showAgentDropdown, setShowAgentDropdown] = useState<string | null>(null)
  const [editingSplitBackup, setEditingSplitBackup] = useState<{
    agentName: string
    agentId?: string | null
    splitPercent: number
    splitAmount: number
  } | null>(null)
  const [editForm, setEditForm] = useState({
    Product_Name__c: '',
    ProductCode: '',
    UnitPrice: '',
    Description: '',
    Project_Deliverables__c: '',
  })
  const [scheduleEditForm, setScheduleEditForm] = useState({
    Revenue: '',
    ScheduleDate: '',
    Description: '',
    Type: '',
    ScheduleSplitPercent: '',
    Billable: false,
    Talent_Invoice_Line_Amount__c: '',
    Wasserman_Invoice_Line_Amount__c: '',
    WD_Payment_Term__c: '',
  })
  const [newProduct, setNewProduct] = useState({
    Product_Name__c: '',
    ProductCode: '',
    UnitPrice: '',
    Quantity: '1',
    TotalPrice: '',
    Division__c: '',
    Contract_Start_Date__c: '',
    Contract_End_Date__c: '',
    Description: '',
    Project_Deliverables__c: '',
  })
  const [newSchedule, setNewSchedule] = useState({
    Description: '',
    ScheduleDate: '',
    Revenue: '',
    WD_Payment_Term__c: 'NET_30',
    Type: 'Revenue',
    Split_Percent__c: '',
    Talent_Invoice_Line_Amount__c: '',
    Wasserman_Invoice_Line_Amount__c: '',
    Active__c: false,
  })
  const [newScheduleId, setNewScheduleId] = useState<string | null>(null)

  const queryClient = useQueryClient()
  const createProduct = useCreateProduct()
  const updateProduct = useUpdateProduct()
  const deleteProduct = useDeleteProduct()
  const createSchedule = useCreateSchedule()
  const updateSchedule = useUpdateSchedule()
  const deleteSchedule = useDeleteSchedule()
  const batchUpdateSplits = useBatchUpdateScheduleSplits()
  const { filterSelection } = useFilter()

  // Get cost center from deal for agent filtering
  const dealCostCenter = deal.Owner_Workday_Cost_Center__c

  // Agent search with cost center filtering
  const { data: agentSearchResults } = useAgentSearch(
    agentSearchTerm,
    filterSelection.type === 'individual' ? filterSelection.value || undefined : dealCostCenter,
    filterSelection.type === 'group' ? filterSelection.value || undefined : undefined,
    4 // Show 3-4 agents as requested
  )

  // Handle highlighted schedule from external navigation (e.g., from payments tab)
  useEffect(() => {
    if (highlightedScheduleId && deal.products) {
      // Find the schedule and its product
      for (const product of deal.products) {
        const schedule = product.schedules?.find(s => s.id === highlightedScheduleId)
        if (schedule) {
          // Expand the product
          setExpandedProducts(prev => new Set(prev).add(product.id))
          // Select the schedule
          setSelectedSchedule({ ...schedule, product })
          setSelectedProductForView(null)
          break
        }
      }
    }
  }, [highlightedScheduleId, deal.products])

  // Handle highlighted product from external navigation (e.g., from payments tab)
  useEffect(() => {
    if (highlightedProductId && deal.products) {
      // Find the product
      const product = deal.products.find(p => p.id === highlightedProductId)
      if (product) {
        // Expand the product
        setExpandedProducts(prev => new Set(prev).add(product.id))
        // Select the product
        setSelectedProductForView(product)
        setSelectedSchedule(null)
      }
    }
  }, [highlightedProductId, deal.products])

  const handleCreateWorkdayProject = () => {
    // Future: Implement Workday project creation
    console.log('Creating Workday project for deal:', deal.id)
  }

  const toggleProductExpansion = (productId: string) => {
    setExpandedProducts(prev => {
      const newSet = new Set(prev)
      if (newSet.has(productId)) {
        newSet.delete(productId)
      } else {
        newSet.add(productId)
      }
      return newSet
    })
  }

  const handleProductClick = (product: Product) => {
    setSelectedProductForView(product)
    setSelectedSchedule(null)
  }

  const handleScheduleClick = (schedule: any, product: Product) => {
    setSelectedSchedule({ ...schedule, product })
    setSelectedProductForView(null)
  }

  const handleEditClick = (product: Product) => {
    setEditingProduct(product)
    setEditForm({
      Product_Name__c: product.Product_Name__c || '',
      ProductCode: product.ProductCode || '',
      UnitPrice: product.UnitPrice?.toString() || '',
      Description: product.Description || '',
      Project_Deliverables__c: product.Project_Deliverables__c || '',
    })
    setIsEditDialogOpen(true)
  }

  const handleSaveEdit = async () => {
    if (!editingProduct) return

    try {
      await updateProduct.mutateAsync({
        id: editingProduct.id,
        product: {
          Product_Name__c: editForm.Product_Name__c,
          ProductCode: editForm.ProductCode,
          UnitPrice: editForm.UnitPrice ? parseFloat(editForm.UnitPrice) : undefined,
          Description: editForm.Description,
          Project_Deliverables__c: editForm.Project_Deliverables__c,
        },
      })

      // Invalidate the deal query to refresh the products
      queryClient.invalidateQueries({ queryKey: dealKeys.detail(deal.id) })

      setIsEditDialogOpen(false)
      setEditingProduct(null)
    } catch (error) {
      console.error('Failed to update product:', error)
    }
  }

  const handleEditScheduleClick = (schedule: Schedule) => {
    setEditingSchedule(schedule)
    const calculatedSplit = calculateSplitPercentage(
      schedule.Wasserman_Invoice_Line_Amount__c,
      schedule.Revenue
    )
    setScheduleEditForm({
      Revenue: schedule.Revenue?.toString() || '',
      ScheduleDate: schedule.ScheduleDate ? schedule.ScheduleDate.split('T')[0] : '',
      Description: schedule.Description || '',
      Type: schedule.Type || '',
      ScheduleSplitPercent: calculatedSplit.toString(),
      Billable: schedule.Active__c || false,
      Talent_Invoice_Line_Amount__c: schedule.Talent_Invoice_Line_Amount__c?.toString() || '',
      Wasserman_Invoice_Line_Amount__c: schedule.Wasserman_Invoice_Line_Amount__c?.toString() || '',
      WD_Payment_Term__c: schedule.WD_Payment_Term__c || '',
    })

    // Load agent splits if they exist
    if ((schedule as any).agentSplits && (schedule as any).agentSplits.length > 0) {
      const splits = (schedule as any).agentSplits.map((split: any) => ({
        id: split.id,
        agentName: split.agentName,
        agentId: split.agentId || null,
        splitPercent: Number(split.splitPercent),
        splitAmount: Number(split.splitAmount)
      }))
      setScheduleAgentSplits(prev => new Map(prev).set(schedule.id, splits))
    } else {
      // Initialize with default splits if none exist
      setScheduleAgentSplits(prev => new Map(prev).set(schedule.id, []))
    }

    setIsEditScheduleDialogOpen(true)
  }

  const handleSaveScheduleEdit = async () => {
    if (!editingSchedule) return

    try {
      // Update schedule basic info
      await updateSchedule.mutateAsync({
        id: editingSchedule.id,
        schedule: {
          Revenue: scheduleEditForm.Revenue ? parseFloat(scheduleEditForm.Revenue) : undefined,
          ScheduleDate: scheduleEditForm.ScheduleDate || undefined,
          Description: scheduleEditForm.Description || undefined,
          Type: scheduleEditForm.Type || undefined,
          ScheduleSplitPercent: scheduleEditForm.ScheduleSplitPercent ? parseFloat(scheduleEditForm.ScheduleSplitPercent) : undefined,
          Active__c: scheduleEditForm.Billable,
          Talent_Invoice_Line_Amount__c: scheduleEditForm.Talent_Invoice_Line_Amount__c ? parseFloat(scheduleEditForm.Talent_Invoice_Line_Amount__c) : undefined,
          Wasserman_Invoice_Line_Amount__c: scheduleEditForm.Wasserman_Invoice_Line_Amount__c ? parseFloat(scheduleEditForm.Wasserman_Invoice_Line_Amount__c) : undefined,
          WD_Payment_Term__c: scheduleEditForm.WD_Payment_Term__c || undefined,
        },
      })

      // Update agent splits if they exist
      const splits = getScheduleSplits(editingSchedule.id).filter(s => s.agentName && s.agentName.trim() !== '')
      if (splits.length > 0) {
        await batchUpdateSplits.mutateAsync({
          scheduleId: editingSchedule.id,
          splits: splits.map(s => ({
            agentName: s.agentName,
            agentId: s.agentId || null,
            splitPercent: s.splitPercent,
            splitAmount: s.splitAmount
          }))
        })
      }

      // Invalidate the deal query to refresh the schedules
      queryClient.invalidateQueries({ queryKey: dealKeys.detail(deal.id) })
      queryClient.invalidateQueries({ queryKey: scheduleKeys.lists() })

      setIsEditScheduleDialogOpen(false)
      setEditingSchedule(null)

      // Update the selected schedule if it's the one being edited
      if (selectedSchedule && selectedSchedule.id === editingSchedule.id) {
        setSelectedSchedule(null)
      }
    } catch (error) {
      console.error('Failed to update schedule:', error)
    }
  }

  const handleDeleteSchedule = async (schedule: Schedule) => {
    if (!confirm(`Are you sure you want to delete this schedule from ${formatDate(schedule.ScheduleDate)}?`)) {
      return
    }

    try {
      await deleteSchedule.mutateAsync(schedule.id)

      // Invalidate queries to refresh the schedule list
      queryClient.invalidateQueries({ queryKey: dealKeys.detail(deal.id) })
      queryClient.invalidateQueries({ queryKey: scheduleKeys.lists() })

      // Clear selected schedule if it's the one being deleted
      if (selectedSchedule && selectedSchedule.id === schedule.id) {
        setSelectedSchedule(null)
      }
    } catch (error) {
      console.error('Failed to delete schedule:', error)
      alert('Failed to delete schedule. Please try again.')
    }
  }

  const handleDeleteProduct = async (product: Product) => {
    const productName = product.Project_Deliverables__c || product.Product_Name__c || 'this product'
    const scheduleCount = product.schedules?.length || 0

    if (scheduleCount > 0) {
      if (!confirm(`This product has ${scheduleCount} schedule(s). Deleting the product will also delete all associated schedules. Are you sure you want to continue?`)) {
        return
      }
    } else {
      if (!confirm(`Are you sure you want to delete ${productName}?`)) {
        return
      }
    }

    try {
      await deleteProduct.mutateAsync(product.id)

      // Invalidate queries to refresh the product list
      queryClient.invalidateQueries({ queryKey: dealKeys.detail(deal.id) })

      // Clear selected product if it's the one being deleted
      if (selectedProduct && selectedProduct.id === product.id) {
        setSelectedProduct(null)
      }
    } catch (error) {
      console.error('Failed to delete product:', error)
      alert('Failed to delete product. Please try again.')
    }
  }

  const formatCurrency = (amount?: number | string) => {
    if (amount === undefined || amount === null || amount === '') return 'N/A'
    const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount
    if (isNaN(numAmount)) return 'N/A'
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(numAmount)
  }

  const getNumericValue = (value?: number | string | null) => {
    if (value === undefined || value === null || value === '') return 0
    if (typeof value === 'string') {
      const parsed = parseFloat(value)
      return isNaN(parsed) ? 0 : parsed
    }
    return value
  }

  const getScheduleCommissionAmount = (schedule: { Wasserman_Invoice_Line_Amount__c?: number | string | null }) => {
    return getNumericValue(schedule.Wasserman_Invoice_Line_Amount__c)
  }


  // Calculation helpers for schedule financial fields
  const recalculateFromRevenue = (revenue: string, splitPercent: string) => {
    const rev = parseFloat(revenue) || 0
    const split = parseFloat(splitPercent) || 0
    const wassermanAmount = (rev * split) / 100
    const talentAmount = rev - wassermanAmount
    return {
      wassermanAmount: wassermanAmount.toFixed(2),
      talentAmount: talentAmount.toFixed(2)
    }
  }

  const recalculateFromSplit = (revenue: string, splitPercent: string) => {
    return recalculateFromRevenue(revenue, splitPercent)
  }

  const recalculateFromTalentAmount = (revenue: string, talentAmount: string) => {
    const rev = parseFloat(revenue) || 0
    const talent = parseFloat(talentAmount) || 0
    const wassermanAmount = rev - talent
    const splitPercent = rev > 0 ? (wassermanAmount / rev) * 100 : 0
    return {
      wassermanAmount: wassermanAmount.toFixed(2),
      splitPercent: splitPercent.toFixed(2)
    }
  }

  const recalculateFromWassermanAmount = (revenue: string, wassermanAmount: string) => {
    const rev = parseFloat(revenue) || 0
    const wasserman = parseFloat(wassermanAmount) || 0
    const talentAmount = rev - wasserman
    const splitPercent = rev > 0 ? (wasserman / rev) * 100 : 0
    return {
      talentAmount: talentAmount.toFixed(2),
      splitPercent: splitPercent.toFixed(2)
    }
  }

  const handleCreateProduct = async () => {
    try {
      await createProduct.mutateAsync({
        ...newProduct,
        dealId: deal.id,
        UnitPrice: newProduct.UnitPrice ? parseFloat(newProduct.UnitPrice) : undefined,
        Quantity: newProduct.Quantity ? parseFloat(newProduct.Quantity) : undefined,
        TotalPrice: newProduct.TotalPrice ? parseFloat(newProduct.TotalPrice) : undefined,
      })

      // Invalidate deal query to refresh products
      queryClient.invalidateQueries({ queryKey: dealKeys.detail(deal.id) })

      setIsCreateDialogOpen(false)
      setNewProduct({
        Product_Name__c: '',
        ProductCode: '',
        UnitPrice: '',
        Quantity: '1',
        TotalPrice: '',
        Division__c: '',
        Contract_Start_Date__c: '',
        Contract_End_Date__c: '',
        Description: '',
        Project_Deliverables__c: '',
      })
    } catch (error) {
      console.error('Failed to create product:', error)
    }
  }

  const handleCreateSchedule = async () => {
    if (!selectedProductForSchedule) {
      alert('Please select a product')
      return
    }

    try {
      const createdSchedule = await createSchedule.mutateAsync({
        ...newSchedule,
        productId: selectedProductForSchedule,
        Revenue: newSchedule.Revenue ? parseFloat(newSchedule.Revenue) : undefined,
        Split_Percent__c: newSchedule.Split_Percent__c ? parseFloat(newSchedule.Split_Percent__c) : undefined,
        Talent_Invoice_Line_Amount__c: newSchedule.Talent_Invoice_Line_Amount__c ? parseFloat(newSchedule.Talent_Invoice_Line_Amount__c) : undefined,
        Wasserman_Invoice_Line_Amount__c: newSchedule.Wasserman_Invoice_Line_Amount__c ? parseFloat(newSchedule.Wasserman_Invoice_Line_Amount__c) : undefined,
      })

      // Save agent splits if any
      if (newScheduleId && scheduleAgentSplits.has(newScheduleId)) {
        const splits = scheduleAgentSplits.get(newScheduleId)!.filter(s => s.agentName && s.agentName.trim() !== '')
        if (splits.length > 0) {
          await batchUpdateSplits.mutateAsync({
            scheduleId: createdSchedule.id,
            splits: splits.map(s => ({
              agentName: s.agentName,
              agentId: s.agentId || null,
              splitPercent: s.splitPercent,
              splitAmount: s.splitAmount
            }))
          })
        }
      }

      // Invalidate deal query to refresh schedules
      queryClient.invalidateQueries({ queryKey: dealKeys.detail(deal.id) })

      setIsAddScheduleDialogOpen(false)
      setSelectedProductForSchedule('')
      setNewSchedule({
        Description: '',
        ScheduleDate: '',
        Revenue: '',
        WD_Payment_Term__c: 'NET_30',
        Type: 'Revenue',
        Split_Percent__c: '',
        Talent_Invoice_Line_Amount__c: '',
        Wasserman_Invoice_Line_Amount__c: '',
        Active__c: false,
      })
      if (newScheduleId) {
        scheduleAgentSplits.delete(newScheduleId)
        setNewScheduleId(null)
      }
    } catch (error) {
      console.error('Failed to create schedule:', error)
    }
  }

  const products = deal.products || []
  const totalProductValue = products.reduce((sum, product) => {
    return sum + getNumericValue(product.TotalPrice ?? product.UnitPrice)
  }, 0)

  const { totalUnpaidScheduleValue, totalUnpaidCommissionValue } = products.reduce((acc, product) => {
    const schedules = product.schedules || []

    schedules.forEach((schedule) => {
      if (schedule.WD_Payment_Status__c?.toLowerCase() === 'paid') {
        return
      }

      acc.totalUnpaidScheduleValue += getNumericValue(schedule.Revenue)
      acc.totalUnpaidCommissionValue += getNumericValue(schedule.Wasserman_Invoice_Line_Amount__c)
    })

    return acc
  }, { totalUnpaidScheduleValue: 0, totalUnpaidCommissionValue: 0 })

  const formatDate = (dateString?: string) => {
    if (!dateString) return 'N/A'
    return new Date(dateString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    })
  }

  const getPaymentStatus = (schedule: any) => {
    // If schedule is not active, payment is not applicable
    if (!schedule.Active__c) {
      return { label: 'Not Applicable', variant: 'outline' as const, className: 'text-muted-foreground' }
    }
    if (schedule.WD_Payment_Status__c?.toLowerCase() === 'paid') {
      return { label: 'Paid', variant: 'default' as const, className: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100' }
    }
    if (schedule.WD_Invoice_ID__c && schedule.WD_Invoice_ID__c !== '') {
      return { label: 'Invoiced', variant: 'secondary' as const, className: '' }
    }
    return { label: 'Pending', variant: 'outline' as const, className: '' }
  }

  const trimProjectName = (projectName?: string) => {
    if (!projectName) return ''
    // Find where "PRODUCT NAME" appears in all caps and take everything before it
    const productNameIndex = projectName.indexOf('PRODUCT NAME')
    if (productNameIndex !== -1) {
      return projectName.substring(0, productNameIndex).trim()
    }
    return projectName
  }

  const calculateSplitPercentage = (wassermanAmount?: number, revenue?: number) => {
    if (!revenue || revenue === 0) return 0
    return Math.round((wassermanAmount || 0) / revenue * 100 * 100) / 100 // Round to 2 decimals
  }

  // Helper functions for agent splits
  const getScheduleSplits = (scheduleId: string) => {
    return scheduleAgentSplits.get(scheduleId) || []
  }

  const initializeScheduleSplits = (scheduleId: string, commissionAmount: number) => {
    // Initialize with agents from the deal's talent clients
    const talentClientAgents = deal.clients
      ?.flatMap(dc => dc.talentClient?.agents || [])
      .filter(Boolean) || []

    // Get unique agents by ID
    const uniqueAgents = Array.from(
      new Map(talentClientAgents.map(ta => [ta.agentId, ta])).values()
    )

    const defaultSplits = uniqueAgents.length > 0
      ? uniqueAgents.map((talentAgent) => {
          const defaultPercent = 100 / uniqueAgents.length
          return {
            agentName: talentAgent.agent?.name || 'Unknown Agent',
            splitPercent: Math.round(defaultPercent * 100) / 100,
            splitAmount: Math.round((commissionAmount * defaultPercent / 100) * 100) / 100,
          }
        })
      : [
          // If no agents, try deal owner
          {
            agentName: deal.owner?.name || '',
            splitPercent: 100,
            splitAmount: commissionAmount,
          }
        ]

    setScheduleAgentSplits(prev => new Map(prev).set(scheduleId, defaultSplits))
  }

  const updateAgentSplit = (
    scheduleId: string,
    splitIndex: number,
    field: 'agentName' | 'splitPercent' | 'splitAmount',
    value: string | number,
    commissionAmount: number
  ) => {
    const splits = getScheduleSplits(scheduleId)
    const newSplits = [...splits]

    if (field === 'agentName') {
      newSplits[splitIndex] = { ...newSplits[splitIndex], agentName: value as string }
    } else if (field === 'splitPercent') {
      const percent = parseFloat(value as string) || 0
      const amount = Math.round((commissionAmount * percent / 100) * 100) / 100
      newSplits[splitIndex] = {
        ...newSplits[splitIndex],
        splitPercent: percent,
        splitAmount: amount
      }
    } else if (field === 'splitAmount') {
      const amount = parseFloat(value as string) || 0
      const percent = commissionAmount > 0 ? Math.round((amount / commissionAmount * 100) * 100) / 100 : 0
      newSplits[splitIndex] = {
        ...newSplits[splitIndex],
        splitAmount: amount,
        splitPercent: percent
      }
    }

    setScheduleAgentSplits(prev => new Map(prev).set(scheduleId, newSplits))
  }

  const addAgentSplit = (scheduleId: string) => {
    const splits = getScheduleSplits(scheduleId)
    const newSplits = [...splits, {
      agentName: '',
      splitPercent: 0,
      splitAmount: 0,
    }]
    setScheduleAgentSplits(prev => new Map(prev).set(scheduleId, newSplits))
  }

  const removeAgentSplit = (scheduleId: string, splitIndex: number) => {
    const splits = getScheduleSplits(scheduleId)
    const newSplits = splits.filter((_, idx) => idx !== splitIndex)
    setScheduleAgentSplits(prev => new Map(prev).set(scheduleId, newSplits))
  }

  const getSplitTotal = (scheduleId: string) => {
    const splits = getScheduleSplits(scheduleId)
    return splits.reduce((sum, split) => sum + split.splitPercent, 0)
  }

  // Extract and deduplicate Workday projects from products
  const workdayProjects = products.reduce((acc, product) => {
    if (product.WD_PRJ_ID__c) {
      const existingProject = acc.find(p => p.WD_PRJ_ID__c === product.WD_PRJ_ID__c)
      if (!existingProject) {
        // Extract project name before "PRODUCT NAME:"
        let projectName = product.WD_Project_Name__c || ''
        const productNameIndex = projectName.indexOf('PRODUCT NAME:')
        if (productNameIndex !== -1) {
          projectName = projectName.substring(0, productNameIndex).trim()
        }

        acc.push({
          WD_PRJ_ID__c: product.WD_PRJ_ID__c,
          WD_Project_Name__c: projectName,
          Workday_Project_State__c: product.Workday_Project_State__c,
          Workday_Project_Status__c: product.Workday_Project_Status__c,
        })
      }
    }
    return acc
  }, [] as Array<{
    WD_PRJ_ID__c: string
    WD_Project_Name__c?: string
    Workday_Project_State__c?: string
    Workday_Project_Status__c?: string
  }>)

  // Auto-expand all products on load
  useEffect(() => {
    if (products.length > 0) {
      const allProductIds = new Set(products.map(p => p.id))
      setExpandedProducts(allProductIds)
    }
  }, [products.length]) // Only run when products are first loaded

  return (
    <div className="space-y-6">
      {/* Products Summary */}
      <div className="grid gap-4 md:grid-cols-3">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Products</CardTitle>
            <Package className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{products.length}</div>
            <p className="text-xs text-muted-foreground">
              Products in deal
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Product Value</CardTitle>
            <DollarSign className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatCurrency(totalProductValue)}
            </div>
            <p className="text-xs text-muted-foreground">
              Total unit prices
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Unpaid Schedule Value</CardTitle>
            <CircleDollarSign className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold flex flex-wrap items-baseline gap-2">
              <span>{formatCurrency(totalUnpaidScheduleValue)}</span>
              <span className="text-sm font-medium text-muted-foreground">
                ({formatCurrency(totalUnpaidCommissionValue)} commission)
              </span>
            </div>
            <p className="text-xs text-muted-foreground">
              Awaiting payment
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Products Table */}
      <Card>
        <CardHeader>
          <div className="flex items-start justify-between gap-4">
            <div>
              <CardTitle>Deal Products</CardTitle>
              <CardDescription>
                Manage products and their associated schedules
              </CardDescription>
            </div>
            <div className="flex items-center gap-2">
              <ProductsViewSelector view={view} onViewChange={setView} />
              <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>
                <DialogTrigger asChild>
                  <Button>
                    <Plus className="mr-2 h-4 w-4" />
                    Add Product
                  </Button>
                </DialogTrigger>
                <DialogContent className="sm:max-w-3xl max-h-[90vh] overflow-y-auto">
                  <DialogHeader>
                    <DialogTitle>Add New Product</DialogTitle>
                    <DialogDescription>
                      Add a new product to this deal
                    </DialogDescription>
                  </DialogHeader>
                  <div className="space-y-4">
                    <div className="grid gap-4 md:grid-cols-2">
                      <div className="space-y-2">
                        <Label htmlFor="productName">Product Name</Label>
                        <Input
                          id="productName"
                          placeholder="e.g., Talent Marketing"
                          value={newProduct.Product_Name__c}
                          onChange={(e) => setNewProduct({ ...newProduct, Product_Name__c: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="productCode">Product Code / Cost Center</Label>
                        <Input
                          id="productCode"
                          placeholder="e.g., CC501"
                          value={newProduct.ProductCode}
                          onChange={(e) => setNewProduct({ ...newProduct, ProductCode: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="unitPrice">Unit Price</Label>
                        <Input
                          id="unitPrice"
                          type="number"
                          step="0.01"
                          placeholder="0.00"
                          value={newProduct.UnitPrice}
                          onChange={(e) => setNewProduct({ ...newProduct, UnitPrice: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="quantity">Quantity</Label>
                        <Input
                          id="quantity"
                          type="number"
                          step="1"
                          placeholder="1"
                          value={newProduct.Quantity}
                          onChange={(e) => setNewProduct({ ...newProduct, Quantity: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="totalPrice">Total Price</Label>
                        <Input
                          id="totalPrice"
                          type="number"
                          step="0.01"
                          placeholder="0.00"
                          value={newProduct.TotalPrice}
                          onChange={(e) => setNewProduct({ ...newProduct, TotalPrice: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="division">Division</Label>
                        <Input
                          id="division"
                          placeholder="e.g., Talent"
                          value={newProduct.Division__c}
                          onChange={(e) => setNewProduct({ ...newProduct, Division__c: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="startDate">Start Date</Label>
                        <Input
                          id="startDate"
                          type="date"
                          value={newProduct.Contract_Start_Date__c}
                          onChange={(e) => setNewProduct({ ...newProduct, Contract_Start_Date__c: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="endDate">End Date</Label>
                        <Input
                          id="endDate"
                          type="date"
                          value={newProduct.Contract_End_Date__c}
                          onChange={(e) => setNewProduct({ ...newProduct, Contract_End_Date__c: e.target.value })}
                        />
                      </div>
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="deliverables">Deliverables</Label>
                      <Textarea
                        id="deliverables"
                        placeholder="Enter project deliverables"
                        rows={2}
                        value={newProduct.Project_Deliverables__c}
                        onChange={(e) => setNewProduct({ ...newProduct, Project_Deliverables__c: e.target.value })}
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="description">Description</Label>
                      <Textarea
                        id="description"
                        placeholder="Product description (optional)"
                        rows={2}
                        value={newProduct.Description}
                        onChange={(e) => setNewProduct({ ...newProduct, Description: e.target.value })}
                      />
                    </div>

                    <div className="flex justify-end gap-2 pt-4">
                      <Button variant="outline" onClick={() => setIsCreateDialogOpen(false)}>
                        Cancel
                      </Button>
                      <Button onClick={handleCreateProduct} disabled={createProduct.isPending}>
                        {createProduct.isPending ? (
                          <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Adding...
                          </>
                        ) : (
                          'Add Product'
                        )}
                      </Button>
                    </div>
                  </div>
                </DialogContent>
              </Dialog>
              <Dialog open={isAddScheduleDialogOpen} onOpenChange={(open) => {
                setIsAddScheduleDialogOpen(open)
                if (open) {
                  // Generate a temporary ID for agent splits
                  const tempId = `temp-schedule-${Date.now()}`
                  setNewScheduleId(tempId)
                  // Auto-select product if only one exists
                  if (products.length === 1) {
                    setSelectedProductForSchedule(products[0].id)
                  }
                }
              }}>
                <DialogTrigger asChild>
                  <Button variant="outline">
                    <Plus className="mr-2 h-4 w-4" />
                    Add Schedule
                  </Button>
                </DialogTrigger>
                <DialogContent className="sm:max-w-3xl max-h-[90vh] overflow-y-auto">
                  <DialogHeader>
                    <DialogTitle>Add New Schedule</DialogTitle>
                    <DialogDescription>
                      Add a new schedule to a product
                    </DialogDescription>
                  </DialogHeader>
                  <div className="space-y-4">
                    {/* Product Selector */}
                    {products.length > 1 && (
                      <div className="space-y-2">
                        <Label htmlFor="productSelect">Product</Label>
                        <Select value={selectedProductForSchedule} onValueChange={setSelectedProductForSchedule}>
                          <SelectTrigger>
                            <SelectValue placeholder="Select product..." />
                          </SelectTrigger>
                          <SelectContent>
                            {products.map(p => (
                              <SelectItem key={p.id} value={p.id}>
                                {p.Project_Deliverables__c || p.Product_Name__c || 'Untitled Product'}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                    )}

                    <div className="grid gap-3 md:grid-cols-2">
                      <div className="space-y-2">
                        <Label className="text-sm">Description</Label>
                        <Input
                          placeholder="Schedule description"
                          value={newSchedule.Description}
                          onChange={(e) => setNewSchedule({ ...newSchedule, Description: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label className="text-sm">Schedule Date</Label>
                        <Input
                          type="date"
                          value={newSchedule.ScheduleDate}
                          onChange={(e) => setNewSchedule({ ...newSchedule, ScheduleDate: e.target.value })}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label className="text-sm">Revenue</Label>
                        <Input
                          type="number"
                          step="0.01"
                          placeholder="0.00"
                          value={newSchedule.Revenue}
                          onChange={(e) => {
                            const { wassermanAmount, talentAmount } = recalculateFromRevenue(
                              e.target.value,
                              newSchedule.Split_Percent__c
                            )
                            setNewSchedule({
                              ...newSchedule,
                              Revenue: e.target.value,
                              Wasserman_Invoice_Line_Amount__c: wassermanAmount,
                              Talent_Invoice_Line_Amount__c: talentAmount,
                            })
                          }}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label className="text-sm">Payment Terms</Label>
                        <Select value={newSchedule.WD_Payment_Term__c} onValueChange={(value) => setNewSchedule({ ...newSchedule, WD_Payment_Term__c: value })}>
                          <SelectTrigger className="h-9">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="NET_15">Net 15</SelectItem>
                            <SelectItem value="NET_30">Net 30</SelectItem>
                            <SelectItem value="NET_45">Net 45</SelectItem>
                            <SelectItem value="NET_60">Net 60</SelectItem>
                            <SelectItem value="DUE_ON_RECEIPT">Due on Receipt</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>

                      <div className="space-y-2">
                        <Label className="text-sm">Type</Label>
                        <Select value={newSchedule.Type} onValueChange={(value) => setNewSchedule({ ...newSchedule, Type: value })}>
                          <SelectTrigger className="h-9">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="Revenue">Revenue</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>

                      <div className="space-y-2">
                        <Label className="text-sm">Split %</Label>
                        <Input
                          type="number"
                          step="0.01"
                          placeholder="0.00"
                          value={newSchedule.Split_Percent__c}
                          onChange={(e) => {
                            const { wassermanAmount, talentAmount } = recalculateFromSplit(
                              newSchedule.Revenue,
                              e.target.value
                            )
                            setNewSchedule({
                              ...newSchedule,
                              Split_Percent__c: e.target.value,
                              Wasserman_Invoice_Line_Amount__c: wassermanAmount,
                              Talent_Invoice_Line_Amount__c: talentAmount,
                            })
                          }}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label className="text-sm">Talent Amount</Label>
                        <Input
                          type="number"
                          step="0.01"
                          placeholder="0.00"
                          value={newSchedule.Talent_Invoice_Line_Amount__c}
                          onChange={(e) => {
                            const { wassermanAmount, splitPercent } = recalculateFromTalentAmount(
                              newSchedule.Revenue,
                              e.target.value
                            )
                            setNewSchedule({
                              ...newSchedule,
                              Talent_Invoice_Line_Amount__c: e.target.value,
                              Wasserman_Invoice_Line_Amount__c: wassermanAmount,
                              Split_Percent__c: splitPercent,
                            })
                          }}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label className="text-sm">Commission Amount</Label>
                        <Input
                          type="number"
                          step="0.01"
                          placeholder="0.00"
                          value={newSchedule.Wasserman_Invoice_Line_Amount__c}
                          onChange={(e) => {
                            const { talentAmount, splitPercent } = recalculateFromWassermanAmount(
                              newSchedule.Revenue,
                              e.target.value
                            )
                            setNewSchedule({
                              ...newSchedule,
                              Wasserman_Invoice_Line_Amount__c: e.target.value,
                              Talent_Invoice_Line_Amount__c: talentAmount,
                              Split_Percent__c: splitPercent,
                            })
                          }}
                        />
                      </div>

                      <div className="flex items-center space-x-2">
                        <input
                          type="checkbox"
                          id="newScheduleBillable"
                          checked={newSchedule.Active__c}
                          onChange={(e) => setNewSchedule({ ...newSchedule, Active__c: e.target.checked })}
                          className="h-4 w-4 rounded border-gray-300"
                        />
                        <Label htmlFor="newScheduleBillable" className="text-sm">
                          Billable
                        </Label>
                      </div>
                    </div>

                    {/* Agent Splits Section */}
                    {newScheduleId && (
                      <div className="space-y-3 pt-4 border-t">
                        <div className="flex items-center justify-between">
                          <Label className="text-sm font-semibold">{labels.agent} Commission Splits</Label>
                          <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => newScheduleId && addAgentSplit(newScheduleId)}
                            className="h-8"
                          >
                            <Plus className="h-3 w-3 mr-1" />
                            Add Split
                          </Button>
                        </div>

                        {getScheduleSplits(newScheduleId).length > 0 ? (
                          <div className="space-y-2">
                            {getScheduleSplits(newScheduleId).map((split, idx) => {
                              const commissionAmount = parseFloat(newSchedule.Wasserman_Invoice_Line_Amount__c) || 0
                              const splitKey = `new-schedule-${idx}`
                              return (
                                <div key={idx} className="grid grid-cols-12 gap-2 items-center p-2 border rounded-lg bg-muted/20">
                                  <div className="col-span-4 relative">
                                    <Input
                                      placeholder={`${labels.agent}/Agency...`}
                                      value={split.agentName}
                                      onChange={(e) => {
                                        setAgentSearchTerm(e.target.value)
                                        newScheduleId && updateAgentSplit(
                                          newScheduleId,
                                          idx,
                                          'agentName',
                                          e.target.value,
                                          commissionAmount
                                        )
                                      }}
                                      onFocus={() => {
                                        setShowAgentDropdown(splitKey)
                                        setAgentSearchTerm('')
                                      }}
                                      onBlur={() => {
                                        // Delay to allow clicking dropdown items
                                        setTimeout(() => setShowAgentDropdown(null), 200)
                                      }}
                                      className="h-8 text-xs"
                                    />
                                    {showAgentDropdown === splitKey && agentSearchResults?.data && agentSearchResults.data.length > 0 && (
                                      <div className="absolute z-50 w-full mt-1 bg-background border rounded-md shadow-lg max-h-48 overflow-auto">
                                        {agentSearchResults.data.map((agent) => (
                                          <div
                                            key={agent.id}
                                            className="px-3 py-2 text-xs hover:bg-muted cursor-pointer"
                                            onMouseDown={(e) => {
                                              e.preventDefault()
                                              newScheduleId && updateAgentSplit(
                                                newScheduleId,
                                                idx,
                                                'agentName',
                                                agent.name,
                                                commissionAmount
                                              )
                                              setShowAgentDropdown(null)
                                              setAgentSearchTerm('')
                                            }}
                                          >
                                            <div className="font-medium">{agent.name}</div>
                                            {agent.costCenter && (
                                              <div className="text-[10px] text-muted-foreground">
                                                {agent.costCenter}
                                              </div>
                                            )}
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                  <div className="col-span-3">
                                    <div className="relative">
                                      <Input
                                        type="number"
                                        placeholder="0"
                                        value={split.splitPercent || ''}
                                        onChange={(e) => newScheduleId && updateAgentSplit(
                                          newScheduleId,
                                          idx,
                                          'splitPercent',
                                          e.target.value,
                                          commissionAmount
                                        )}
                                        className="h-8 text-xs pr-6"
                                      />
                                      <span className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-muted-foreground pointer-events-none">%</span>
                                    </div>
                                  </div>
                                  <div className="col-span-4">
                                    <div className="relative">
                                      <span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-muted-foreground pointer-events-none">$</span>
                                      <Input
                                        type="number"
                                        placeholder="0"
                                        value={split.splitAmount || ''}
                                        onChange={(e) => newScheduleId && updateAgentSplit(
                                          newScheduleId,
                                          idx,
                                          'splitAmount',
                                          e.target.value,
                                          commissionAmount
                                        )}
                                        className="h-8 text-xs pl-5"
                                      />
                                    </div>
                                  </div>
                                  <div className="col-span-1 flex justify-end">
                                    <Button
                                      type="button"
                                      variant="ghost"
                                      size="sm"
                                      onClick={() => newScheduleId && removeAgentSplit(newScheduleId, idx)}
                                      className="h-8 w-8 p-0"
                                    >
                                      <Trash2 className="h-3 w-3" />
                                    </Button>
                                  </div>
                                </div>
                              )
                            })}
                            <div className="flex items-center justify-between text-xs font-medium px-2">
                              <span className="text-muted-foreground">Total Split:</span>
                              <span className={getSplitTotal(newScheduleId) === 100 ? 'text-green-600' : 'text-red-600'}>
                                {getSplitTotal(newScheduleId).toFixed(2)}%
                              </span>
                            </div>
                          </div>
                        ) : (
                          <div className="text-xs text-muted-foreground text-center py-4 border border-dashed rounded-lg">
                            No commission splits configured
                          </div>
                        )}
                      </div>
                    )}

                    <div className="flex justify-end gap-2 pt-4">
                      <Button variant="outline" onClick={() => setIsAddScheduleDialogOpen(false)}>
                        Cancel
                      </Button>
                      <Button onClick={handleCreateSchedule} disabled={createSchedule.isPending}>
                        {createSchedule.isPending ? (
                          <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Adding...
                          </>
                        ) : (
                          'Add Schedule'
                        )}
                      </Button>
                    </div>
                  </div>
                </DialogContent>
              </Dialog>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {/* Edit Product Dialog */}
          <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
            <DialogContent className="sm:max-w-md">
              <DialogHeader>
                <DialogTitle>Edit Product</DialogTitle>
                <DialogDescription>
                  Update product details and save changes
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="editProjectDeliverables">Project Deliverables</Label>
                  <Input
                    id="editProjectDeliverables"
                    placeholder="Project deliverables..."
                    value={editForm.Project_Deliverables__c}
                    onChange={(e) => setEditForm({ ...editForm, Project_Deliverables__c: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="editProductName">Product Name</Label>
                  <Input
                    id="editProductName"
                    placeholder="Product name..."
                    value={editForm.Product_Name__c}
                    onChange={(e) => setEditForm({ ...editForm, Product_Name__c: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="editProductCode">Cost Center</Label>
                  <Input
                    id="editProductCode"
                    placeholder="Cost center code..."
                    value={editForm.ProductCode}
                    onChange={(e) => setEditForm({ ...editForm, ProductCode: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="editUnitPrice">Unit Price</Label>
                  <Input
                    id="editUnitPrice"
                    type="number"
                    placeholder="0.00"
                    value={editForm.UnitPrice}
                    onChange={(e) => setEditForm({ ...editForm, UnitPrice: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="editDescription">Description</Label>
                  <Textarea
                    id="editDescription"
                    placeholder="Product description..."
                    value={editForm.Description}
                    onChange={(e) => setEditForm({ ...editForm, Description: e.target.value })}
                  />
                </div>

                <div className="flex justify-end gap-2 pt-4">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setIsEditDialogOpen(false)
                      setEditingProduct(null)
                    }}
                  >
                    Cancel
                  </Button>
                  <Button
                    onClick={handleSaveEdit}
                    disabled={updateProduct.isPending}
                  >
                    {updateProduct.isPending ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        Saving...
                      </>
                    ) : (
                      'Save Changes'
                    )}
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>

          {/* Edit Schedule Dialog */}
          <Dialog open={isEditScheduleDialogOpen} onOpenChange={setIsEditScheduleDialogOpen}>
            <DialogContent className="sm:max-w-lg">
              <DialogHeader>
                <DialogTitle>Edit Schedule</DialogTitle>
                <DialogDescription>
                  Update schedule details and save changes
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="editScheduleDate">Schedule Date</Label>
                    <Input
                      id="editScheduleDate"
                      type="date"
                      value={scheduleEditForm.ScheduleDate}
                      onChange={(e) => setScheduleEditForm({ ...scheduleEditForm, ScheduleDate: e.target.value })}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="editRevenue">Revenue</Label>
                    <Input
                      id="editRevenue"
                      type="number"
                      placeholder="0.00"
                      value={scheduleEditForm.Revenue}
                      onChange={(e) => {
                        const revenue = parseFloat(e.target.value) || 0
                        const splitPercent = parseFloat(scheduleEditForm.ScheduleSplitPercent) || 0
                        const wassermanAmount = (revenue * splitPercent) / 100
                        const talentAmount = revenue - wassermanAmount
                        setScheduleEditForm({
                          ...scheduleEditForm,
                          Revenue: e.target.value,
                          Wasserman_Invoice_Line_Amount__c: wassermanAmount.toFixed(2),
                          Talent_Invoice_Line_Amount__c: talentAmount.toFixed(2),
                        })
                      }}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="editTalentAmount">Talent Amount</Label>
                    <Input
                      id="editTalentAmount"
                      type="number"
                      placeholder="0.00"
                      value={scheduleEditForm.Talent_Invoice_Line_Amount__c}
                      onChange={(e) => {
                        const talentAmount = parseFloat(e.target.value) || 0
                        const revenue = parseFloat(scheduleEditForm.Revenue) || 0
                        const wassermanAmount = revenue - talentAmount
                        const splitPercent = calculateSplitPercentage(wassermanAmount, revenue)
                        setScheduleEditForm({
                          ...scheduleEditForm,
                          Talent_Invoice_Line_Amount__c: e.target.value,
                          Wasserman_Invoice_Line_Amount__c: wassermanAmount.toFixed(2),
                          ScheduleSplitPercent: splitPercent.toString(),
                        })
                      }}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="editWassermanAmount">Commission Amount</Label>
                    <Input
                      id="editWassermanAmount"
                      type="number"
                      placeholder="0.00"
                      value={scheduleEditForm.Wasserman_Invoice_Line_Amount__c}
                      onChange={(e) => {
                        const wassermanAmount = parseFloat(e.target.value) || 0
                        const revenue = parseFloat(scheduleEditForm.Revenue) || 0
                        const talentAmount = revenue - wassermanAmount
                        const splitPercent = calculateSplitPercentage(wassermanAmount, revenue)
                        setScheduleEditForm({
                          ...scheduleEditForm,
                          Wasserman_Invoice_Line_Amount__c: e.target.value,
                          Talent_Invoice_Line_Amount__c: talentAmount.toFixed(2),
                          ScheduleSplitPercent: splitPercent.toString(),
                        })
                      }}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="editType">Type</Label>
                    <Input
                      id="editType"
                      placeholder="Schedule type..."
                      value={scheduleEditForm.Type}
                      onChange={(e) => setScheduleEditForm({ ...scheduleEditForm, Type: e.target.value })}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="editSplitPercent">Split % (Commission)</Label>
                    <Input
                      id="editSplitPercent"
                      type="number"
                      placeholder="0"
                      value={scheduleEditForm.ScheduleSplitPercent}
                      onChange={(e) => {
                        const splitPercent = parseFloat(e.target.value) || 0
                        const revenue = parseFloat(scheduleEditForm.Revenue) || 0
                        const wassermanAmount = (revenue * splitPercent) / 100
                        const talentAmount = revenue - wassermanAmount
                        setScheduleEditForm({
                          ...scheduleEditForm,
                          ScheduleSplitPercent: e.target.value,
                          Wasserman_Invoice_Line_Amount__c: wassermanAmount.toFixed(2),
                          Talent_Invoice_Line_Amount__c: talentAmount.toFixed(2),
                        })
                      }}
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="editPaymentTerms">Payment Terms</Label>
                  <Input
                    id="editPaymentTerms"
                    placeholder="e.g., Net 15, Net 30..."
                    value={scheduleEditForm.WD_Payment_Term__c}
                    onChange={(e) => setScheduleEditForm({ ...scheduleEditForm, WD_Payment_Term__c: e.target.value })}
                  />
                </div>

                <div className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="editActive"
                    checked={scheduleEditForm.Billable}
                    onChange={(e) => setScheduleEditForm({ ...scheduleEditForm, Billable: e.target.checked })}
                    className="h-4 w-4"
                  />
                  <Label htmlFor="editActive" className="text-sm font-medium">
                    Billable
                  </Label>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="editScheduleDescription">Description</Label>
                  <Textarea
                    id="editScheduleDescription"
                    placeholder="Schedule description..."
                    value={scheduleEditForm.Description}
                    onChange={(e) => setScheduleEditForm({ ...scheduleEditForm, Description: e.target.value })}
                    rows={3}
                  />
                </div>

                {/* Agent Splits */}
                {editingSchedule && (
                  <div className="space-y-3 pt-4 border-t">
                    <div className="flex items-center justify-between">
                      <Label className="text-sm font-semibold">{labels.agent} Commission Splits</Label>
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => addAgentSplit(editingSchedule.id)}
                        className="h-8"
                      >
                        <Plus className="h-3 w-3 mr-1" />
                        Add Split
                      </Button>
                    </div>

                    {getScheduleSplits(editingSchedule.id).length > 0 ? (
                      <div className="space-y-2">
                        {getScheduleSplits(editingSchedule.id).map((split, idx) => {
                          const commissionAmount = parseFloat(scheduleEditForm.Wasserman_Invoice_Line_Amount__c) || 0
                          return (
                            <div key={idx} className="grid grid-cols-12 gap-2 items-center p-2 border rounded-lg bg-muted/20">
                              <div className="col-span-4">
                                <Input
                                  placeholder={`${labels.agent} name...`}
                                  value={split.agentName}
                                  onChange={(e) => updateAgentSplit(
                                    editingSchedule.id,
                                    idx,
                                    'agentName',
                                    e.target.value,
                                    commissionAmount
                                  )}
                                  className="h-8 text-xs"
                                />
                              </div>
                              <div className="col-span-3">
                                <div className="relative">
                                  <Input
                                    type="number"
                                    placeholder="0"
                                    value={split.splitPercent || ''}
                                    onChange={(e) => updateAgentSplit(
                                      editingSchedule.id,
                                      idx,
                                      'splitPercent',
                                      e.target.value,
                                      commissionAmount
                                    )}
                                    className="h-8 text-xs pr-6"
                                  />
                                  <span className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-muted-foreground pointer-events-none">
                                    %
                                  </span>
                                </div>
                              </div>
                              <div className="col-span-4">
                                <div className="relative">
                                  <span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-muted-foreground pointer-events-none">
                                    $
                                  </span>
                                  <Input
                                    type="number"
                                    placeholder="0"
                                    value={split.splitAmount || ''}
                                    onChange={(e) => updateAgentSplit(
                                      editingSchedule.id,
                                      idx,
                                      'splitAmount',
                                      e.target.value,
                                      commissionAmount
                                    )}
                                    className="h-8 text-xs pl-5"
                                  />
                                </div>
                              </div>
                              <div className="col-span-1 flex justify-end">
                                <Button
                                  type="button"
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => removeAgentSplit(editingSchedule.id, idx)}
                                  className="h-8 w-8 p-0"
                                >
                                  <Trash2 className="h-3 w-3" />
                                </Button>
                              </div>
                            </div>
                          )
                        })}
                        <div className="flex items-center justify-between text-xs font-medium px-2">
                          <span className="text-muted-foreground">Total Split:</span>
                          <span className={getSplitTotal(editingSchedule.id) === 100 ? 'text-green-600' : 'text-red-600'}>
                            {getSplitTotal(editingSchedule.id).toFixed(2)}%
                          </span>
                        </div>
                      </div>
                    ) : (
                      <div className="text-xs text-muted-foreground text-center py-4 border border-dashed rounded-lg">
                        No commission splits configured
                      </div>
                    )}
                  </div>
                )}

                <div className="flex justify-end gap-2 pt-4">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setIsEditScheduleDialogOpen(false)
                      setEditingSchedule(null)
                    }}
                  >
                    Cancel
                  </Button>
                  <Button
                    onClick={handleSaveScheduleEdit}
                    disabled={updateSchedule.isPending}
                  >
                    {updateSchedule.isPending ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        Saving...
                      </>
                    ) : (
                      'Save Changes'
                    )}
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>

          {/* Link Existing Workday Project Dialog */}
          <Dialog open={isLinkProjectDialogOpen} onOpenChange={setIsLinkProjectDialogOpen}>
            <DialogContent className="sm:max-w-md">
              <DialogHeader>
                <DialogTitle>Link Existing Workday Project</DialogTitle>
                <DialogDescription>
                  Enter the Workday Project ID to link to this product
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="projectId">Workday Project ID</Label>
                  <Input
                    id="projectId"
                    placeholder="Enter project ID..."
                    value={linkProjectId}
                    onChange={(e) => setLinkProjectId(e.target.value)}
                  />
                </div>

                <div className="flex justify-end gap-2 pt-4">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setIsLinkProjectDialogOpen(false)
                      setLinkProjectId('')
                      setLinkingProduct(null)
                    }}
                  >
                    Cancel
                  </Button>
                  <Button
                    onClick={async () => {
                      if (!linkingProduct) return

                      try {
                        await updateProduct.mutateAsync({
                          id: linkingProduct.id,
                          product: {
                            WD_PRJ_ID__c: linkProjectId,
                          },
                        })

                        // Invalidate the deal query to refresh the product
                        queryClient.invalidateQueries({ queryKey: dealKeys.detail(deal.id) })

                        setIsLinkProjectDialogOpen(false)
                        setLinkProjectId('')
                        setLinkingProduct(null)
                      } catch (error) {
                        console.error('Failed to link Workday project:', error)
                      }
                    }}
                    disabled={!linkProjectId || updateProduct.isPending}
                  >
                    {updateProduct.isPending ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        Linking...
                      </>
                    ) : (
                      'Link Project'
                    )}
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>

          {products.length === 0 ? (
            <div className="text-center py-12 text-muted-foreground">
              <Package className="h-12 w-12 mx-auto mb-3 opacity-20" />
              <p>No products added yet</p>
            </div>
          ) : view === 'grouped' ? (
            <GroupedTableView
              products={products}
              formatCurrency={formatCurrency}
              formatDate={formatDate}
              getPaymentStatus={getPaymentStatus}
              calculateSplitPercentage={calculateSplitPercentage}
              onEditSchedule={handleEditScheduleClick}
              onDeleteSchedule={handleDeleteSchedule}
              onEditProduct={handleEditClick}
              onDeleteProduct={handleDeleteProduct}
              onNavigateToPayment={onNavigateToPayment}
              getNumericValue={getNumericValue}
            />
          ) : view === 'flat' ? (
            <FlatTableView
              products={products}
              formatCurrency={formatCurrency}
              formatDate={formatDate}
              getPaymentStatus={getPaymentStatus}
              calculateSplitPercentage={calculateSplitPercentage}
              onEditSchedule={handleEditScheduleClick}
              onDeleteSchedule={handleDeleteSchedule}
              onEditProduct={handleEditClick}
              onDeleteProduct={handleDeleteProduct}
              onNavigateToPayment={onNavigateToPayment}
              getNumericValue={getNumericValue}
            />
          ) : view === 'master-detail' ? (
            <MasterDetailView
              products={products}
              formatCurrency={formatCurrency}
              formatDate={formatDate}
              getPaymentStatus={getPaymentStatus}
              calculateSplitPercentage={calculateSplitPercentage}
              onEditSchedule={handleEditScheduleClick}
              onDeleteSchedule={handleDeleteSchedule}
              onEditProduct={handleEditClick}
              onDeleteProduct={handleDeleteProduct}
              onNavigateToPayment={onNavigateToPayment}
              getNumericValue={getNumericValue}
            />
          ) : view === 'compact' ? (
            <CompactRowsView
              products={products}
              formatCurrency={formatCurrency}
              formatDate={formatDate}
              getPaymentStatus={getPaymentStatus}
              calculateSplitPercentage={calculateSplitPercentage}
              onEditSchedule={handleEditScheduleClick}
              onDeleteSchedule={handleDeleteSchedule}
              onEditProduct={handleEditClick}
              onDeleteProduct={handleDeleteProduct}
              onNavigateToPayment={onNavigateToPayment}
              getNumericValue={getNumericValue}
            />
          ) : (
            <div className="grid gap-6 lg:grid-cols-3">
              {/* Left: Products List */}
              <Card className="lg:col-span-1">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Package className="h-5 w-5" />
                    Products ({products.length})
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    {products.map((product) => {
                      const productSchedules = product.schedules || []
                      const isExpanded = expandedProducts.has(product.id)
                      const hasSchedules = productSchedules.length > 0

                      return (
                        <div key={product.id} className="space-y-1">
                          {/* Product Item */}
                          <div
                            className={`p-3 border rounded-lg transition-colors ${
                              selectedProductForView?.id === product.id && !selectedSchedule
                                ? 'bg-primary/10 border-primary'
                                : 'hover:bg-muted/50'
                            }`}
                          >
                            <div className="flex items-start gap-2">
                              {/* Chevron for expansion */}
                              {hasSchedules && (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    toggleProductExpansion(product.id)
                                  }}
                                  className="mt-1 hover:bg-muted/50 rounded p-0.5"
                                >
                                  {isExpanded ? (
                                    <ChevronDown className="h-4 w-4" />
                                  ) : (
                                    <ChevronRight className="h-4 w-4" />
                                  )}
                                </button>
                              )}

                              {/* Product Content */}
                              <div
                                className="flex-1 cursor-pointer"
                                onClick={() => handleProductClick(product)}
                              >
                                <div className="font-medium text-sm">
                                  {product.Project_Deliverables__c || 'Untitled Product'}
                                </div>
                                {product.Product_Name__c && (
                                  <div className="text-xs text-muted-foreground mt-1">
                                    {product.Product_Name__c}
                                  </div>
                                )}
                                <div className="flex items-center gap-2 mt-2">
                                  {product.ProductCode && (
                                    <Badge variant="outline" className="text-xs">
                                      {product.ProductCode}
                                    </Badge>
                                  )}
                                  {hasSchedules && (
                                    <span className="text-xs text-muted-foreground">
                                      {productSchedules.length} schedule{productSchedules.length !== 1 ? 's' : ''}
                                    </span>
                                  )}
                                </div>
                                <div className="flex items-center gap-3 mt-2 text-xs text-muted-foreground">
                                  <div className="flex items-center gap-1">
                                    <DollarSign className="h-3 w-3" />
                                    {formatCurrency(product.UnitPrice)}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Schedules List (when expanded) */}
                          {isExpanded && hasSchedules && (
                            <div className="ml-6 space-y-1">
                              {productSchedules.map((schedule: any) => {
                                const isPaid = schedule.WD_Payment_Status__c?.toLowerCase() === 'paid'
                                const isInvoiced = schedule.WD_Invoice_ID__c && schedule.WD_Invoice_ID__c !== ''

                                return (
                                  <div
                                    key={schedule.id}
                                    id={`schedule-${schedule.id}`}
                                    className={`p-2 pl-4 border-l-2 rounded cursor-pointer transition-colors ${
                                      selectedSchedule?.id === schedule.id
                                        ? 'bg-primary/10 border-l-primary'
                                        : 'border-l-muted hover:bg-muted/50'
                                    }`}
                                    onClick={() => handleScheduleClick(schedule, product)}
                                  >
                                    <div className="flex items-center gap-2">
                                      <div className="flex gap-1">
                                        {isInvoiced && (
                                          <Receipt className="h-3 w-3 text-blue-600 dark:text-blue-400" />
                                        )}
                                        {isPaid && (
                                          <DollarSign className="h-3 w-3 text-green-600 dark:text-green-400" />
                                        )}
                                      </div>
                                      <Calendar className="h-3 w-3 text-muted-foreground" />
                                      <div className="flex-1">
                                        <div className="font-medium text-xs">{formatDate(schedule.ScheduleDate)}</div>
                                        <div className="flex items-center gap-3 mt-1 text-xs text-muted-foreground">
                                          <span>{formatCurrency(getNumericValue(schedule.Revenue))}</span>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                )
                              })}
                            </div>
                          )}
                        </div>
                      )
                    })}
                  </div>
                </CardContent>
              </Card>

              {/* Right: Product/Schedule Details */}
              <Card className="lg:col-span-2 lg:sticky lg:top-4 lg:max-h-[calc(100vh-2rem)] lg:overflow-y-auto">
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <CardTitle>
                      {selectedSchedule
                        ? `Schedule: ${formatDate(selectedSchedule.ScheduleDate)}`
                        : selectedProductForView
                          ? selectedProductForView.Project_Deliverables__c || selectedProductForView.Product_Name__c || 'Product Details'
                          : products[0]?.Project_Deliverables__c || products[0]?.Product_Name__c || 'Select a product to view details'}
                    </CardTitle>
                    {selectedSchedule && (
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setSelectedSchedule(null)}
                      >
                        Back to Product
                      </Button>
                    )}
                    {!selectedSchedule && selectedProductForView && (
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleEditClick(selectedProductForView)}
                      >
                        <Edit className="h-4 w-4 mr-2" />
                        Edit Product
                      </Button>
                    )}
                  </div>
                </CardHeader>
                <CardContent>
                  {selectedSchedule ? (
                    /* Schedule Details View */
                    <div className="space-y-6">
                      {/* Schedule Information Card */}
                      <div className="p-4 border rounded-lg space-y-4">
                        <div className="flex items-center gap-2 mb-3">
                          <Calendar className="h-5 w-5 text-muted-foreground" />
                          <span className="font-medium text-lg">{formatDate(selectedSchedule.ScheduleDate)}</span>
                        </div>
                        <div className="space-y-3">
                          <div className="flex justify-between text-sm">
                            <span className="text-muted-foreground">Revenue</span>
                            <span className="font-medium text-sm">{formatCurrency(selectedSchedule.Revenue ? Number(selectedSchedule.Revenue) : 0)}</span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-muted-foreground">Split %</span>
                            <span className="font-medium text-sm">
                              {calculateSplitPercentage(
                                selectedSchedule.Wasserman_Invoice_Line_Amount__c ? Number(selectedSchedule.Wasserman_Invoice_Line_Amount__c) : 0,
                                selectedSchedule.Revenue ? Number(selectedSchedule.Revenue) : 0
                              )}%
                            </span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-muted-foreground">Talent</span>
                            <span className="font-medium text-sm text-green-600 dark:text-green-400">
                              {formatCurrency(selectedSchedule.Talent_Invoice_Line_Amount__c ? Number(selectedSchedule.Talent_Invoice_Line_Amount__c) : 0)}
                            </span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-muted-foreground">Commission</span>
                            <span className="font-medium text-sm text-orange-600 dark:text-orange-400">
                              {formatCurrency(selectedSchedule.Wasserman_Invoice_Line_Amount__c ? Number(selectedSchedule.Wasserman_Invoice_Line_Amount__c) : 0)}
                            </span>
                          </div>
                        </div>
                      </div>

                      <Separator />

                      {/* Schedule Details Grid */}
                      <div className="space-y-4">
                        <h3 className="text-sm font-semibold">Schedule Details</h3>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <div className="text-sm text-muted-foreground mb-1">Type</div>
                            <div className="text-sm font-medium">{selectedSchedule.Type || 'N/A'}</div>
                          </div>
                          <div>
                            <div className="text-sm text-muted-foreground mb-1">Billable</div>
                            <Badge variant={selectedSchedule.Active__c ? 'default' : 'secondary'} className="text-xs">
                              {selectedSchedule.Active__c ? 'Yes' : 'No'}
                            </Badge>
                          </div>
                          <div>
                            <div className="text-sm text-muted-foreground mb-1">Payment Terms</div>
                            <div className="text-sm font-medium">{selectedSchedule.WD_Payment_Term__c || 'N/A'}</div>
                          </div>
                          <div>
                            <div className="text-sm text-muted-foreground mb-1">Payment Status</div>
                            <Badge variant={getPaymentStatus(selectedSchedule).variant} className={`text-xs ${getPaymentStatus(selectedSchedule).className}`}>
                              {getPaymentStatus(selectedSchedule).label}
                            </Badge>
                          </div>
                          {selectedSchedule.WD_Invoice_ID__c && (
                            <div>
                              <div className="text-sm text-muted-foreground mb-1">Invoice ID</div>
                              <div className="text-xs font-mono">{selectedSchedule.WD_Invoice_ID__c}</div>
                            </div>
                          )}
                          {selectedSchedule.WD_PO_Number__c && (
                            <div>
                              <div className="text-sm text-muted-foreground mb-1">PO Number</div>
                              <div className="text-xs font-mono">{selectedSchedule.WD_PO_Number__c}</div>
                            </div>
                          )}
                        </div>
                        {selectedSchedule.Description && (
                          <div>
                            <div className="text-sm text-muted-foreground mb-1">Description</div>
                            <div className="text-sm">{selectedSchedule.Description}</div>
                          </div>
                        )}
                      </div>

                      <Separator />

                      {/* Commission Splits */}
                      {selectedSchedule.agentSplits && selectedSchedule.agentSplits.length > 0 && (
                        <>
                          <div className="space-y-4">
                            <h3 className="text-sm font-semibold flex items-center gap-2">
                              <Users className="h-4 w-4" />
                              Commission Splits
                            </h3>
                            <div className="space-y-2">
                              {selectedSchedule.agentSplits.map((split: any, idx: number) => (
                                <div key={idx} className="flex items-center justify-between p-3 border rounded-lg bg-muted/20">
                                  <div className="flex-1">
                                    <div className="text-sm font-medium">{split.agentName}</div>
                                    <div className="text-xs text-muted-foreground mt-0.5">
                                      {split.splitPercent}% • {formatCurrency(split.splitAmount)}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>

                          <Separator />
                        </>
                      )}

                      {/* Schedule Actions */}
                      <div className="flex gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          className={selectedSchedule.Active__c ? "flex-1" : "w-full"}
                          onClick={() => handleEditScheduleClick(selectedSchedule)}
                        >
                          <Edit className="h-4 w-4 mr-2" />
                          Edit Schedule
                        </Button>
                        {selectedSchedule.Active__c && (
                          <Button variant="outline" size="sm" className="flex-1">
                            <Receipt className="h-4 w-4 mr-2" />
                            Create Invoice
                          </Button>
                        )}
                      </div>

                      <Separator />

                      {/* Payment Details */}
                      <div className="space-y-4">
                        <div className="flex items-center justify-between">
                          <h3 className="text-sm font-semibold flex items-center gap-2">
                            <CreditCard className="h-4 w-4" />
                            Payment Details
                          </h3>
                          {selectedSchedule.paymentRemittance?.payment && onNavigateToPayment && (
                            <Button
                              variant="ghost"
                              size="sm"
                              className="h-6 w-6 p-0"
                              onClick={() => {
                                if (selectedSchedule.paymentRemittance?.payment) {
                                  onNavigateToPayment(selectedSchedule.paymentRemittance.payment.id)
                                }
                              }}
                            >
                              <ExternalLink className="h-3 w-3" />
                            </Button>
                          )}
                        </div>
                        {selectedSchedule.paymentRemittance?.payment ? (
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <div className="text-sm text-muted-foreground mb-1">Payment Number</div>
                              <div className="text-sm font-medium">
                                {selectedSchedule.paymentRemittance.payment.paymentNumber || selectedSchedule.paymentRemittance.payment.id.slice(0, 8)}
                              </div>
                            </div>
                            <div>
                              <div className="text-sm text-muted-foreground mb-1">Payment Amount</div>
                              <div className="text-sm font-semibold text-green-600 dark:text-green-400">
                                {formatCurrency(selectedSchedule.paymentRemittance.payment.paymentAmount || 0)}
                              </div>
                            </div>
                            <div>
                              <div className="text-sm text-muted-foreground mb-1">Payment Date</div>
                              <div className="text-sm font-medium">
                                {formatDate(selectedSchedule.paymentRemittance.payment.paymentDate)}
                              </div>
                            </div>
                            <div>
                              <div className="text-sm text-muted-foreground mb-1">Payment Status</div>
                              <Badge variant="outline" className="text-xs">
                                {selectedSchedule.paymentRemittance.payment.paymentStatus || 'Unknown'}
                              </Badge>
                            </div>
                            {selectedSchedule.paymentRemittance.payment.paymentType && (
                              <div>
                                <div className="text-sm text-muted-foreground mb-1">Payment Type</div>
                                <div className="text-sm font-medium">
                                  {selectedSchedule.paymentRemittance.payment.paymentType}
                                </div>
                              </div>
                            )}
                          </div>
                        ) : (
                          <div className="text-sm text-muted-foreground p-4 bg-muted/50 rounded-lg text-center">
                            No payment linked to this schedule yet
                          </div>
                        )}
                      </div>
                    </div>
                  ) : !selectedProductForView && !products[0] ? (
                    <div className="text-center py-8 text-muted-foreground">
                      <p>No products available</p>
                    </div>
                  ) : (
                    /* Product Details View */
                    <div className="space-y-6">
                      {(() => {
                        const activeProduct = selectedProductForView || products[0]
                        const productSchedules = activeProduct.schedules || []
                        const totalPrice = getNumericValue(activeProduct.TotalPrice ?? activeProduct.UnitPrice)
                        const totalCommission = productSchedules.reduce((sum, schedule) => {
                          return sum + getNumericValue(schedule.Wasserman_Invoice_Line_Amount__c)
                        }, 0)
                        const paidCommission = productSchedules.reduce((sum, schedule) => {
                          return schedule.WD_Payment_Status__c?.toLowerCase() === 'paid'
                            ? sum + getNumericValue(schedule.Wasserman_Invoice_Line_Amount__c)
                            : sum
                        }, 0)
                        const unpaidCommission = Math.max(totalCommission - paidCommission, 0)
                        return (
                          <>
                            {/* Product Information */}
                            <div className="space-y-3">
                              <div className="flex items-center justify-between gap-4">
                                <h3 className="text-sm font-semibold flex items-center gap-2">
                                  <Package className="h-4 w-4" />
                                  Product Details
                                </h3>

                                {/* Price Badges - Top Right */}
                                <div className="flex flex-wrap items-center gap-3 justify-end">
                                  {/* Total Price Badge */}
                                  <div className="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-blue-50 dark:bg-blue-950/30 transition-all hover:scale-105">
                                    <DollarSign className="h-5 w-5 text-blue-600 dark:text-blue-400" />
                                    <div className="flex flex-col">
                                      <span className="text-xs font-medium text-muted-foreground">
                                        Total Price
                                      </span>
                                      <span className="text-lg font-bold text-blue-600 dark:text-blue-400">
                                        {formatCurrency(totalPrice)}
                                      </span>
                                    </div>
                                  </div>

                                  {/* Total Commission Badge */}
                                  <div className="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-orange-50 dark:bg-orange-950/30 transition-all hover:scale-105">
                                    <DollarSign className="h-5 w-5 text-orange-600 dark:text-orange-400" />
                                    <div className="flex flex-col">
                                      <span className="text-xs font-medium text-muted-foreground">
                                        Commission
                                      </span>
                                      <span className="text-lg font-bold text-orange-600 dark:text-orange-400">
                                        {formatCurrency(totalCommission)}
                                      </span>
                                    </div>
                                  </div>

                                  {/* Paid Commission Badge */}
                                  <div className="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-green-50 dark:bg-green-950/30 transition-all hover:scale-105">
                                    <Receipt className="h-5 w-5 text-green-600 dark:text-green-400" />
                                    <div className="flex flex-col">
                                      <span className="text-xs font-medium text-muted-foreground">
                                        Paid
                                      </span>
                                      <span className="text-lg font-bold text-green-600 dark:text-green-400">
                                        {formatCurrency(paidCommission)}
                                      </span>
                                    </div>
                                  </div>

                                  {/* Unpaid Commission Badge */}
                                  <div className="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-amber-50 dark:bg-amber-950/30 transition-all hover:scale-105">
                                    <Receipt className="h-5 w-5 text-amber-600 dark:text-amber-400" />
                                    <div className="flex flex-col">
                                      <span className="text-xs font-medium text-muted-foreground">
                                        Unpaid
                                      </span>
                                      <span className="text-lg font-bold text-amber-600 dark:text-amber-400">
                                        {formatCurrency(unpaidCommission)}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div className="col-span-2">
                                  <div className="text-sm text-muted-foreground mb-1">Deliverables</div>
                                  <div className="text-sm font-medium">
                                    {activeProduct.Project_Deliverables__c || 'No deliverables specified'}
                                  </div>
                                </div>
                                {activeProduct.Product_Name__c && (
                                  <div className="col-span-2">
                                    <div className="text-sm text-muted-foreground mb-1">Product Name</div>
                                    <div className="text-sm font-medium">{activeProduct.Product_Name__c}</div>
                                  </div>
                                )}
                                {activeProduct.ProductCode && (
                                  <div>
                                    <div className="text-sm text-muted-foreground mb-1">Cost Center</div>
                                    <Badge variant="outline" className="text-xs">
                                      {activeProduct.ProductCode}
                                    </Badge>
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Workday Information */}
                            <Separator />
                            <div className="space-y-4">
                              <h3 className="text-sm font-semibold">Workday</h3>
                              {(activeProduct.WD_PRJ_ID__c || activeProduct.WD_Project_Name__c) ? (
                                <div className="grid grid-cols-2 gap-4">
                                  {activeProduct.WD_PRJ_ID__c && (
                                    <div>
                                      <div className="text-sm text-muted-foreground mb-1">Project ID</div>
                                      <div className="text-sm font-medium">{activeProduct.WD_PRJ_ID__c}</div>
                                    </div>
                                  )}
                                  {activeProduct.WD_Project_Name__c && (
                                    <div>
                                      <div className="text-sm text-muted-foreground mb-1">Project Name</div>
                                      <div className="text-sm font-medium">{trimProjectName(activeProduct.WD_Project_Name__c)}</div>
                                    </div>
                                  )}
                                  {activeProduct.Workday_Project_State__c && (
                                    <div>
                                      <div className="text-sm text-muted-foreground mb-1">Project State</div>
                                      <Badge variant="secondary" className="text-xs">
                                        {activeProduct.Workday_Project_State__c}
                                      </Badge>
                                    </div>
                                  )}
                                  {activeProduct.Workday_Project_Status__c && (
                                    <div>
                                      <div className="text-sm text-muted-foreground mb-1">Project Status</div>
                                      <Badge variant="outline" className="text-xs">
                                        {activeProduct.Workday_Project_Status__c}
                                      </Badge>
                                    </div>
                                  )}
                                </div>
                              ) : (
                                <div className="space-y-3">
                                  <p className="text-sm text-muted-foreground">No Workday project linked</p>
                                  <div className="flex gap-2">
                                    <Button
                                      variant="outline"
                                      size="sm"
                                      className="flex-1"
                                      onClick={handleCreateWorkdayProject}
                                    >
                                      <Plus className="h-4 w-4 mr-2" />
                                      Create Workday Project
                                    </Button>
                                    <Button
                                      variant="outline"
                                      size="sm"
                                      className="flex-1"
                                      onClick={() => {
                                        setLinkingProduct(activeProduct)
                                        setIsLinkProjectDialogOpen(true)
                                      }}
                                    >
                                      <ExternalLink className="h-4 w-4 mr-2" />
                                      Link Existing Project
                                    </Button>
                                  </div>
                                </div>
                              )}
                            </div>

                            <Separator />

                            {/* Payment Schedules */}
                            <div className="space-y-4">
                              <h3 className="text-sm font-semibold">Payment Schedules</h3>
                              {!activeProduct.schedules || activeProduct.schedules.length === 0 ? (
                                <div className="text-center py-8 text-muted-foreground">
                                  <Calendar className="h-8 w-8 mx-auto mb-2 opacity-20" />
                                  <p className="text-sm">No schedules configured</p>
                                </div>
                              ) : (
                                <div className="space-y-2">
                                  {activeProduct.schedules.map((schedule: any) => {
                                    const status = getPaymentStatus(schedule)
                                    const isPaid = schedule.WD_Payment_Status__c?.toLowerCase() === 'paid'
                                    const isInvoiced = schedule.WD_Invoice_ID__c && schedule.WD_Invoice_ID__c !== ''
                                    const scheduleRevenue = getNumericValue(schedule.Revenue)
                                    const commissionAmount = getScheduleCommissionAmount(schedule)
                                    const splits = getScheduleSplits(schedule.id)
                                    const splitTotal = getSplitTotal(schedule.id)
                                    const hasSplitWarning = splits.length > 0 && Math.abs(splitTotal - 100) > 0.01
                                    const canEditSplits = !isPaid

                                    // Initialize splits if not yet done
                                    if (!scheduleAgentSplits.has(schedule.id)) {
                                      initializeScheduleSplits(schedule.id, commissionAmount)
                                    }

                                    return (
                                      <div key={schedule.id} className="border rounded-lg">
                                        {/* Schedule Header */}
                                        <div
                                          className="p-3 hover:bg-muted/50 cursor-pointer transition-colors"
                                          onClick={() => handleScheduleClick(schedule, activeProduct)}
                                        >
                                          <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                              <div className="flex gap-1">
                                                {isInvoiced && (
                                                  <Receipt className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                                                )}
                                                {isPaid && (
                                                  <DollarSign className="h-4 w-4 text-green-600 dark:text-green-400" />
                                                )}
                                              </div>
                                              <div>
                                                <div className="text-sm font-medium">{formatDate(schedule.ScheduleDate)}</div>
                                                <div className="text-xs text-muted-foreground">
                                                  {formatCurrency(scheduleRevenue)} revenue • {formatCurrency(commissionAmount)} commission
                                                </div>
                                              </div>
                                            </div>
                                            <Badge variant={status.variant} className={`text-xs ${status.className}`}>
                                              {status.label}
                                            </Badge>
                                          </div>
                                        </div>

                                        {/* Agent Splits (Always Visible) */}
                                        <div className="px-3 pb-3 border-t bg-muted/20">
                                          <div className="pt-3 space-y-3">
                                            <div className="flex items-center justify-between">
                                              <h4 className="text-xs font-semibold text-muted-foreground flex items-center gap-2">
                                                <Users className="h-3 w-3" />
                                                Commission Splits
                                              </h4>
                                              {hasSplitWarning && (
                                                <span className="text-xs text-orange-600 dark:text-orange-400">
                                                  Total: {splitTotal.toFixed(2)}% (should be 100%)
                                                </span>
                                              )}
                                            </div>

                                            {/* Split Rows */}
                                            <div className="space-y-2">
                                              {splits.map((split, idx) => {
                                                const splitKey = `${schedule.id}-${idx}`
                                                const isEditing = editingSplitId === splitKey

                                                return isEditing ? (
                                                  // Edit Mode
                                                  <div key={idx} className="grid grid-cols-12 gap-2 items-center p-2 border rounded-lg bg-background">
                                                    <div className="col-span-3 relative">
                                                      <Input
                                                        placeholder={`${labels.agent}/Agency...`}
                                                        value={split.agentName}
                                                        onChange={(e) => {
                                                          e.stopPropagation()
                                                          setAgentSearchTerm(e.target.value)
                                                          updateAgentSplit(
                                                            schedule.id,
                                                            idx,
                                                            'agentName',
                                                            e.target.value,
                                                            commissionAmount
                                                          )
                                                        }}
                                                        onFocus={(e) => {
                                                          e.stopPropagation()
                                                          setShowAgentDropdown(splitKey)
                                                          setAgentSearchTerm('')
                                                        }}
                                                        onBlur={() => {
                                                          // Delay to allow clicking dropdown items
                                                          setTimeout(() => setShowAgentDropdown(null), 200)
                                                        }}
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="h-8 text-xs"
                                                      />
                                                      {showAgentDropdown === splitKey && agentSearchResults?.data && agentSearchResults.data.length > 0 && (
                                                        <div className="absolute z-50 w-full mt-1 bg-background border rounded-md shadow-lg max-h-48 overflow-auto">
                                                          {agentSearchResults.data.map((agent) => (
                                                            <div
                                                              key={agent.id}
                                                              className="px-3 py-2 text-xs hover:bg-muted cursor-pointer"
                                                              onMouseDown={(e) => {
                                                                e.preventDefault()
                                                                e.stopPropagation()
                                                                updateAgentSplit(
                                                                  schedule.id,
                                                                  idx,
                                                                  'agentName',
                                                                  agent.name,
                                                                  commissionAmount
                                                                )
                                                                setShowAgentDropdown(null)
                                                                setAgentSearchTerm('')
                                                              }}
                                                            >
                                                              <div className="font-medium">{agent.name}</div>
                                                              {agent.costCenter && (
                                                                <div className="text-[10px] text-muted-foreground">
                                                                  {agent.costCenter}
                                                                </div>
                                                              )}
                                                            </div>
                                                          ))}
                                                        </div>
                                                      )}
                                                    </div>
                                                    <div className="col-span-2">
                                                      <div className="relative">
                                                        <Input
                                                          type="number"
                                                          placeholder="0"
                                                          value={split.splitPercent || ''}
                                                          onChange={(e) => {
                                                            e.stopPropagation()
                                                            updateAgentSplit(
                                                              schedule.id,
                                                              idx,
                                                              'splitPercent',
                                                              e.target.value,
                                                              commissionAmount
                                                            )
                                                          }}
                                                          onClick={(e) => e.stopPropagation()}
                                                          className="h-8 text-xs pr-6"
                                                        />
                                                        <span className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-muted-foreground pointer-events-none">
                                                          %
                                                        </span>
                                                      </div>
                                                    </div>
                                                    <div className="col-span-4">
                                                      <div className="relative">
                                                        <span className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-muted-foreground pointer-events-none">
                                                          $
                                                        </span>
                                                        <Input
                                                          type="number"
                                                          placeholder="0"
                                                          value={split.splitAmount || ''}
                                                          onChange={(e) => {
                                                            e.stopPropagation()
                                                            updateAgentSplit(
                                                              schedule.id,
                                                              idx,
                                                              'splitAmount',
                                                              e.target.value,
                                                              commissionAmount
                                                            )
                                                          }}
                                                          onClick={(e) => e.stopPropagation()}
                                                          className="h-8 text-xs pl-5"
                                                        />
                                                      </div>
                                                    </div>
                                                    <div className="col-span-2 flex gap-1 justify-end">
                                                      <Button
                                                        variant="ghost"
                                                        size="sm"
                                                        onClick={async (e) => {
                                                          e.stopPropagation()

                                                          // Save all splits for this schedule, filter out empty agent names
                                                          let currentSplits = getScheduleSplits(schedule.id)
                                                            .filter(s => s.agentName && s.agentName.trim() !== '')

                                                          // Calculate total percentage
                                                          const totalPercent = currentSplits.reduce((sum, s) => sum + s.splitPercent, 0)

                                                          // If total is less than 100%, add an "Unassigned" split for the remainder
                                                          if (totalPercent < 100) {
                                                            const remainingPercent = Math.round((100 - totalPercent) * 100) / 100
                                                            const remainingAmount = Math.round((commissionAmount * remainingPercent / 100) * 100) / 100

                                                            currentSplits = [
                                                              ...currentSplits,
                                                              {
                                                                agentName: 'Unassigned',
                                                                agentId: null,
                                                                splitPercent: remainingPercent,
                                                                splitAmount: remainingAmount
                                                              }
                                                            ]
                                                          }

                                                          try {
                                                            await batchUpdateSplits.mutateAsync({
                                                              scheduleId: schedule.id,
                                                              splits: currentSplits.map(s => ({
                                                                agentName: s.agentName,
                                                                agentId: s.agentId || null,
                                                                splitPercent: s.splitPercent,
                                                                splitAmount: s.splitAmount
                                                              }))
                                                            })
                                                          } catch (error) {
                                                            console.error('Failed to save splits:', error)
                                                          }

                                                          setEditingSplitId(null)
                                                          setEditingSplitBackup(null)
                                                        }}
                                                        disabled={batchUpdateSplits.isPending}
                                                        className="h-8 w-8 p-0 text-green-600 hover:text-green-700 hover:bg-green-100 dark:hover:bg-green-900"
                                                      >
                                                        {batchUpdateSplits.isPending ? (
                                                          <Loader2 className="h-3 w-3 animate-spin" />
                                                        ) : (
                                                          <Check className="h-3 w-3" />
                                                        )}
                                                      </Button>
                                                      <Button
                                                        variant="ghost"
                                                        size="sm"
                                                        onClick={(e) => {
                                                          e.stopPropagation()
                                                          // Restore backup if exists
                                                          if (editingSplitBackup) {
                                                            updateAgentSplit(
                                                              schedule.id,
                                                              idx,
                                                              'agentName',
                                                              editingSplitBackup.agentName,
                                                              commissionAmount
                                                            )
                                                            // Also restore percent and amount
                                                            const splits = getScheduleSplits(schedule.id)
                                                            const newSplits = [...splits]
                                                            newSplits[idx] = editingSplitBackup
                                                            setScheduleAgentSplits(prev => new Map(prev).set(schedule.id, newSplits))
                                                          }
                                                          setEditingSplitId(null)
                                                          setEditingSplitBackup(null)
                                                        }}
                                                        className="h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-muted"
                                                      >
                                                        <X className="h-3 w-3" />
                                                      </Button>
                                                      {splits.length > 1 && (
                                                        <Button
                                                          variant="ghost"
                                                          size="sm"
                                                          onClick={async (e) => {
                                                            e.stopPropagation()
                                                            // Remove split and save to database
                                                            removeAgentSplit(schedule.id, idx)

                                                            // Get updated splits after removal, filter out empty agent names
                                                            const updatedSplits = getScheduleSplits(schedule.id)
                                                              .filter((_, i) => i !== idx)
                                                              .filter(s => s.agentName && s.agentName.trim() !== '')

                                                            try {
                                                              await batchUpdateSplits.mutateAsync({
                                                                scheduleId: schedule.id,
                                                                splits: updatedSplits.map(s => ({
                                                                  agentName: s.agentName,
                                                                  agentId: s.agentId || null,
                                                                  splitPercent: s.splitPercent,
                                                                  splitAmount: s.splitAmount
                                                                }))
                                                              })
                                                            } catch (error) {
                                                              console.error('Failed to delete split:', error)
                                                            }

                                                            setEditingSplitId(null)
                                                            setEditingSplitBackup(null)
                                                          }}
                                                          disabled={batchUpdateSplits.isPending}
                                                          className="h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900"
                                                        >
                                                          <Trash2 className="h-3 w-3" />
                                                        </Button>
                                                      )}
                                                    </div>
                                                  </div>
                                                ) : (
                                                  // Read-Only Mode
                                                  <div key={idx} className={`grid grid-cols-12 gap-2 items-center p-2 border rounded-lg transition-colors ${canEditSplits ? 'hover:bg-muted/50' : 'opacity-60'}`}>
                                                    <div className="col-span-3">
                                                      <div className="text-[10px] text-muted-foreground uppercase tracking-wide mb-0.5">Split Recipient</div>
                                                      <div className="text-xs font-medium">{split.agentName || 'Not set'}</div>
                                                    </div>
                                                    <div className="col-span-2">
                                                      <div className="text-[10px] text-muted-foreground uppercase tracking-wide mb-0.5">Split %</div>
                                                      <div className="text-xs font-medium">{split.splitPercent}%</div>
                                                    </div>
                                                    <div className="col-span-4">
                                                      <div className="text-[10px] text-muted-foreground uppercase tracking-wide mb-0.5">Split Amount</div>
                                                      <div className="text-xs font-medium">{formatCurrency(split.splitAmount)}</div>
                                                    </div>
                                                    <div className="col-span-3 flex gap-1 justify-end">
                                                      {canEditSplits && (
                                                        <>
                                                          <Button
                                                            variant="ghost"
                                                            size="sm"
                                                            onClick={(e) => {
                                                              e.stopPropagation()
                                                              // Backup current values before editing
                                                              setEditingSplitBackup({
                                                                agentName: split.agentName,
                                                                splitPercent: split.splitPercent,
                                                                splitAmount: split.splitAmount,
                                                              })
                                                              setEditingSplitId(splitKey)
                                                            }}
                                                            className="h-8 w-8 p-0"
                                                          >
                                                            <Edit className="h-3 w-3" />
                                                          </Button>
                                                          {splits.length > 1 && (
                                                            <Button
                                                              variant="ghost"
                                                              size="sm"
                                                              onClick={(e) => {
                                                                e.stopPropagation()
                                                                removeAgentSplit(schedule.id, idx)
                                                              }}
                                                              className="h-8 w-8 p-0"
                                                            >
                                                              <X className="h-3 w-3" />
                                                            </Button>
                                                          )}
                                                        </>
                                                      )}
                                                    </div>
                                                  </div>
                                                )
                                              })}
                                            </div>

                                            {/* Add Split Button */}
                                            {canEditSplits ? (
                                              <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={(e) => {
                                                  e.stopPropagation()
                                                  addAgentSplit(schedule.id)
                                                }}
                                                className="w-full h-8 text-xs"
                                              >
                                                <Plus className="h-3 w-3 mr-1" />
                                                Add Split
                                              </Button>
                                            ) : (
                                              <div className="w-full p-2 text-center text-xs text-muted-foreground border border-dashed rounded-lg">
                                                Cannot modify splits once paid
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      </div>
                                    )
                                  })}
                                </div>
                              )}
                            </div>
                          </>
                        )
                      })()}
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Workday Integration */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <ExternalLink className="h-5 w-5" />
            Workday Integration
          </CardTitle>
          <CardDescription>
            {workdayProjects.length > 0
              ? `${workdayProjects.length} Workday ${workdayProjects.length === 1 ? 'project' : 'projects'} linked to this deal`
              : 'Project creation and management in Workday'
            }
          </CardDescription>
        </CardHeader>
        <CardContent>
          {workdayProjects.length === 0 ? (
            <div className="flex items-center justify-between">
              <div className="space-y-1">
                <div className="font-medium">Workday Project</div>
                <div className="text-sm text-muted-foreground">
                  No project created yet
                </div>
              </div>

              <Button onClick={handleCreateWorkdayProject}>
                <Plus className="mr-2 h-4 w-4" />
                Create Project
              </Button>
            </div>
          ) : (
            <div className="space-y-3">
              {workdayProjects.map((project) => (
                <div key={project.WD_PRJ_ID__c} className="flex items-center justify-between p-4 rounded-lg border">
                  <div className="space-y-1">
                    <div className="font-medium">
                      {project.WD_Project_Name__c || 'Untitled Project'}
                    </div>
                    <div className="text-sm text-muted-foreground">
                      Project ID: {project.WD_PRJ_ID__c}
                    </div>
                    {(project.Workday_Project_State__c || project.Workday_Project_Status__c) && (
                      <div className="flex gap-2 mt-2">
                        {project.Workday_Project_State__c && (
                          <Badge variant="secondary">{project.Workday_Project_State__c}</Badge>
                        )}
                        {project.Workday_Project_Status__c && (
                          <Badge variant="outline">{project.Workday_Project_Status__c}</Badge>
                        )}
                      </div>
                    )}
                  </div>
                  <Button variant="outline">
                    <ExternalLink className="mr-2 h-4 w-4" />
                    Open in Workday
                  </Button>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
